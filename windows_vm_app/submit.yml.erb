<%-
  emailcmd = '/uufs/chpc.utah.edu/sys/bin/CHPCEmailLookup.sh ' + ENV["USER"]
  emailaddr = %x[ #{emailcmd}]
  if gpu_type != "none" 
     if gpu_type == "any" 
      gpustr="--gres=gpu:"+gpu_count
     else
      gpustr="--gres=gpu:"+gpu_type+":"+gpu_count
     end
     if gpu_profile == "1" 
       gpustr << ",nsight:1"
     end
  end
-%>
# Note conn_params section below is copied from BYU's submit script
# Watch closely
batch_connect:
  template: "basic"
  conn_params:
    - guacd_rdp_enabled
    - guacd_rdp_port
    - guacd_rdp_authtoken
    - ws_console_enabled
    - ws_console_port
    - websockify_token
    - win_user
    - win_password
    - tls_proxy_enabled
    - job
    - rdpport  
script:
  accounting_id: "<%= custom_accpart.split(":")[0]%>"
  queue_name: "<%= custom_accpart.split(":")[1] %>"
  qos: "<%= custom_accpart.split(":")[2] %>"
  email: <%= emailaddr %>
  job_environment: 
    SMBCONF: <%= $custom_user_group_dirs %>
  <%- if /frisco/.match(cluster) == nil and /crystalpeak/.match(cluster) == nil -%>
  native:
    - "-N"
    - "1"
    - "-n"
    - "8"
#   - "<%= num_cores %>" 
    <%- if gpu_type != "none" -%>
    - <%= gpustr %>
    <%- end -%>
    <%- if memtask != "" and memtask != "0" -%>
    - "--mem"
#    - "22G"
    - "<%= memtask %>G"
    <%- end -%>
    <%- if nodelist != "" -%>
    - "-w"
    - "<%= nodelist %>"
    <%- end -%>
    <%- if constraint != "" -%>
    - "-C"
    - "<%= constraint %>"
    <%- end -%>
    - "--iso-netns-listeners"
    - "3"
#    - "--oodproxy-register=1"
  <%- end -%>



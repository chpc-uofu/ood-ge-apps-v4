#!/bin/bash

# print out every command
# set -x

# Benchmark info
echo "TIMING - Starting main script at: $(date)"

################################################################################
# Environment Modules
################################################################################

# make sure module command is available
. /usr/share/Modules/init/bash

# Purge the module environment to avoid conflicts
module purge

# load pre-defined versions from the list
module load <%= context.version %>

################################################################################
################################################################################
#
# Start program
#

# Benchmark info
echo "TIMING - Starting user program at: $(date)"

<%- if context.version.include?("mysql") -%>

mysqld --datadir="$MYSQL_DATA"
  
<%- elsif context.version.include?("mariadb") -%>

mariadbd --datadir="$MYSQL_DATA"

<%- elsif context.version.include?("postgres") -%>

# start postgres
pg_ctl start

# Get the PID of the postgress instance
postgres_pid=$(head -1 ${PGDATA}/postmaster.pid)

# As long as the PID directory exists we wait
while [[ -d "/proc/$postgres_pid" ]]; do
  #sleep 1
  
  time_target=$(($SLURM_JOB_END_TIME - 60)) # end of slurm job minus 1 minute
  time_current=$(date +%s)                  # current time
  
  while [ "$time_current" -lt "$time_target" ]; do
      sleep 30
      time_current=$(date +%s) # update current time
  done
  
  pg_ctl stop # gracefully shut down the database server

done

<%- end -%>
